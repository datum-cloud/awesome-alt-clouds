name: Admin Approve Submission

on:
  issue_comment:
    types: [created]

jobs:
  approve:
    # Only run on issues (not PRs) with submission label when admin comments /approve or approve
    if: |
      !github.event.issue.pull_request &&
      contains(github.event.issue.labels.*.name, 'submission') &&
      startsWith(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Check if user is admin/maintainer
        id: check-permission
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.actor
            });

            const allowed = ['admin', 'maintain', 'write'].includes(permission.permission);
            console.log(`User ${context.actor} has ${permission.permission} permission. Allowed: ${allowed}`);

            if (!allowed) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `❌ @${context.actor} You don't have permission to approve submissions.`
              });
              core.setOutput('allowed', 'false');
            } else {
              core.setOutput('allowed', 'true');
            }

      - name: Parse approval command
        if: steps.check-permission.outputs.allowed == 'true'
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.trim();
            // Match formats:
            // /approve 3 - approve all with score 3
            // /approve all 3 - approve all with score 3
            // /approve warp.dev 3 - approve specific domain with score 3
            // /approve https://warp.dev 3 - approve specific URL with score 3

            // Try specific URL/domain pattern first: /approve <url-or-domain> <score>
            let match = comment.match(/^\/approve\s+(https?:\/\/[^\s]+|[a-z0-9][\w.-]+\.[a-z]{2,})\s+(\d)/i);

            if (match) {
              const targetUrl = match[1];
              const scoreOverride = parseInt(match[2]);
              console.log(`Specific approval: ${targetUrl} with score ${scoreOverride}`);
              core.setOutput('target_url', targetUrl);
              core.setOutput('score_override', scoreOverride);
              core.setOutput('valid', 'true');
              return;
            }

            // Try "all" pattern: /approve all <score>
            match = comment.match(/^\/approve\s+all\s+(\d)/i);
            if (match) {
              const scoreOverride = parseInt(match[1]);
              console.log(`Approve all with score ${scoreOverride}`);
              core.setOutput('target_url', 'all');
              core.setOutput('score_override', scoreOverride);
              core.setOutput('valid', 'true');
              return;
            }

            // Try simple pattern: /approve <score>
            match = comment.match(/^\/approve\s+(\d)$/i);
            if (match) {
              const scoreOverride = parseInt(match[1]);
              console.log(`Approve all (implicit) with score ${scoreOverride}`);
              core.setOutput('target_url', 'all');
              core.setOutput('score_override', scoreOverride);
              core.setOutput('valid', 'true');
              return;
            }

            // Just /approve without score
            match = comment.match(/^\/approve$/i);
            if (match) {
              console.log('Approve all without score override');
              core.setOutput('target_url', 'all');
              core.setOutput('score_override', '');
              core.setOutput('valid', 'true');
              return;
            }

            console.log('No valid approve command found');
            core.setOutput('valid', 'false');

      - name: Checkout
        if: steps.check-permission.outputs.allowed == 'true' && steps.parse.outputs.valid == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.check-permission.outputs.allowed == 'true' && steps.parse.outputs.valid == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.check-permission.outputs.allowed == 'true' && steps.parse.outputs.valid == 'true'
        run: |
          pip install requests beautifulsoup4 anthropic

      - name: Re-evaluate with admin override
        if: steps.check-permission.outputs.allowed == 'true' && steps.parse.outputs.valid == 'true'
        id: evaluate
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ADMIN_SCORE_OVERRIDE: ${{ steps.parse.outputs.score_override }}
          ADMIN_TARGET_URL: ${{ steps.parse.outputs.target_url }}
          ADMIN_APPROVED: 'true'
        run: |
          echo "=== Admin Approval Mode ==="
          echo "Issue Number: $ISSUE_NUMBER"
          echo "Target URL: $ADMIN_TARGET_URL"
          echo "Score Override: $ADMIN_SCORE_OVERRIDE"
          echo ""
          python scripts/evaluate_submission.py
          echo ""
          echo "=== Evaluation Complete ==="
          echo "Files created:"
          ls -la *.json *.txt *.md 2>/dev/null || echo "No output files found"

      - name: Create PR
        if: steps.check-permission.outputs.allowed == 'true' && steps.parse.outputs.valid == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "=== Debug: Checking for submission_data.json ==="
          if [ -f submission_data.json ]; then
            echo "Found submission_data.json:"
            cat submission_data.json
            echo ""
            echo "=== Creating PR ==="
            python scripts/create_submission_pr.py
          else
            echo "ERROR: No submission_data.json found"
            echo "Files in current directory:"
            ls -la
            exit 1
          fi

      - name: Update labels and comment
        if: steps.check-permission.outputs.allowed == 'true' && steps.parse.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Remove old labels
            const labelsToRemove = ['needs-review', 'rejected'];
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label
                });
              } catch (e) {
                // Label might not exist
              }
            }

            // Add approved label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['approved']
            });

            // Add success comment
            const scoreOverride = '${{ steps.parse.outputs.score_override }}';
            const scoreMsg = scoreOverride ? ` with score override to ${scoreOverride}/3` : '';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **Approved by @${context.actor}**${scoreMsg}\n\nA PR has been created to add this service to the directory.`
            });
